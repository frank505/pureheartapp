default_platform(:ios)

platform :ios do
  desc "Fetch certificates and provisioning profiles"
  lane :certificates do
    setup_ci if ENV['CI']
    match(type: "appstore", readonly: true)
  end
  
  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci if ENV['CI']
    certificates
    
    # Clean build folder
    clear_derived_data
    
    # Increment build number
    increment_build_number(xcodeproj: "PureHeart.xcodeproj")
    
    # Build the app with automatic signing
    build_app(
      workspace: "PureHeart.xcworkspace",
      scheme: "PureHeart",
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false
      },
      xcargs: "-allowProvisioningUpdates CODE_SIGN_STYLE=Automatic DEVELOPMENT_TEAM=U8M48L26Z9"
    )
    
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false
    )
  end
  
  desc "Just build without uploading (for debugging)"
  lane :build_only do
    setup_ci if ENV['CI']
    certificates
    
    # Clean build folder
    clear_derived_data
    
    # Enable automatic signing and build
    build_app(
      workspace: "PureHeart.xcworkspace",
      scheme: "PureHeart",
      configuration: "Release",
      clean: true,
      skip_package_ipa: true,
      skip_archive: false,
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates CODE_SIGN_STYLE=Automatic DEVELOPMENT_TEAM=U8M48L26Z9"
    )
  end
  
  desc "Generate new certificates and profiles"
  lane :generate_certs do
    match(type: "appstore", force_for_new_devices: true)
  end
  
  desc "Sync certificates for development"
  lane :sync_certs do
    setup_ci if ENV['CI']
    match(type: "development", readonly: true)
    match(type: "appstore", readonly: true)
  end
  
  desc "Register new device and regenerate profiles"
  lane :add_device do |options|
    device_name = options[:name] || prompt(text: "Device Name: ")
    device_udid = options[:udid] || prompt(text: "Device UDID: ")
    
    register_devices(
      devices: {
        device_name => device_udid
      }
    )
    
    match(type: "development", force_for_new_devices: true)
  end
end
