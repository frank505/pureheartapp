name: iOS TestFlight Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ secrets.RUBY_VERSION }}
          bundler-cache: true
          
      - name: Setup Keychain
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=temporary_password
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          
      - name: Install dependencies
        run: |
          npm ci --legacy-peer-deps
          cd ios && pod install
          
      - name: Setup Fastlane
        run: |
          cd ios
          echo 'source "https://rubygems.org"' > Gemfile
          echo 'gem "fastlane"' >> Gemfile
          echo 'gem "cocoapods"' >> Gemfile
          echo 'gem "abbrev"' >> Gemfile
          bundle install
          
          # Create Appfile with API key authentication
          echo 'app_identifier("${{ secrets.IOS_BUNDLE_ID }}")' > fastlane/Appfile
          echo 'team_id("${{ secrets.IOS_TEAM_ID }}")' >> fastlane/Appfile
          
          # Create Matchfile
          # Use token-based authentication by embedding token in git URL
          GIT_URL_WITH_TOKEN=$(echo "${{ secrets.MATCH_GIT_URL }}" | sed "s|https://github.com/|https://x-access-token:${{ secrets.MATCH_GIT_TOKEN }}@github.com/|")
          echo "git_url(\"$GIT_URL_WITH_TOKEN\")" > fastlane/Matchfile
          echo 'storage_mode("git")' >> fastlane/Matchfile
          echo 'type("appstore")' >> fastlane/Matchfile
          echo 'app_identifier(["${{ secrets.IOS_BUNDLE_ID }}"])' >> fastlane/Matchfile
          
          # Create Fastfile for API key authentication
          cat > fastlane/Fastfile << 'EOL'
          default_platform(:ios)

          platform :ios do
            desc "Deploy to TestFlight"
            lane :testflight_deploy do
              # Setup API Key authentication
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
                key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
                is_key_content_base64: true,
                duration: 1200
              )
              
              # Automatic code signing with match
              match(
                type: "appstore",
                readonly: true,
                keychain_name: ENV["KEYCHAIN_PATH"],
                keychain_password: ENV["KEYCHAIN_PASSWORD"],
                api_key: api_key
              )
              
              # Build the app
              gym(
                workspace: "pureheart.xcworkspace",
                scheme: "pureheart",
                export_method: "app-store",
                configuration: "Release",
                clean: true,
                output_name: "pureheart.ipa"
              )
              
              # Upload to TestFlight
              pilot(
                api_key: api_key,
                skip_waiting_for_build_processing: true,
                skip_submission: true,
                distribute_external: false
              )
            end
          end
          EOL
          
      - name: Deploy to TestFlight
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_TOKEN: ${{ secrets.MATCH_GIT_TOKEN }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
        run: |
          cd ios
          bundle exec fastlane testflight_deploy
